# 性能优化准则笔记
作者这篇文章主要是对“编程智慧”发表关于优化的观点看法。
“编程智慧”关于优化的观点为：
> Rule1:别优化  
> Rule2(专家):也别优化

作者的观点：
> 1. 从项目第一天开始为性能设计  
> 2. 经常性能分析   
> 3. 警惕性能下降  
> 4. 清楚明白数据  
> 5. 深刻理解硬件  
> 6. 帮助编译器优化  
> 7. 验证自己的假想  
> 8. 每个人对性能负责  

Knuth的名言:
> 提前优化是万恶之源

这句话并不是说要延后优化，或不优化。而是说首先找到代码运行的瓶颈然后优化。

如果说项目一开始不注重性能优化，那等到项目变大，伴随着项目发布压力，版本bug，新的功能特性这些问题。再去看性能优化，已经病入膏肓很难在去做优化。从项目开始关注项目中占用资源top 3%的函数，做好分析和优化工作，逐步积累，就不会导致最后的尾大不掉。

性能文化就是：性能是你产品的核心特征。坏的性能意味着差的用户体验，尤其是游戏，导致不可玩和不能发行。从产品设计开始就考虑性能。在产品原型阶段，为了演示和想法验证阶段，可以不考虑性能细节。但是到了产品主线，在设计系统时需要考虑规模，不是说对每条指令和一字节内存斤斤计较。而是说要考虑系统要处理的规模，提出不同的方案，比如下面的例子：

* 处理很少的对象，几乎不需要关心性能
* 上百个对象，优化算法，合理组织对象
* 上千个对象，批次操作，考虑内存消耗，访问模式和带宽。考虑根据对象可见性分成不同集合，或层次划分
* 成千上万个对象，可能需要考虑对线程
* 百万级别，那可能需要考虑时钟运行周期，以及缓存命中率这些问题

工作大多数时间花在已经存在的代码而不是写新的代码，同样的几乎每天将时间用在调试，维护和修复代码而不是优化。并不是说性能比其他问题更重要，而是说性能问题和其他问题同等重要。这就像没有产品到末期才修复bug，同样的不可能将优化代码拖到产品后期。同样的不可能团队只留一个人修复bug，其他成员开发功能，性能优化也是同样的道理，不可能专门有性能优化人员这一说。

性能优化工作人人有责，所以需要成为工作流程中的一环。这就对应到条目3，警惕性能下降。如果性能意外下降，这将是最高优先级去调查和修复的问题。有专门的系统去侦测，才能及时知道性能下降，比如使用自动测试生成日常性能报表。团队成员也需要经常进行性能分析，对各个模块的性能消耗了然于胸，这样的话，当哪里出了问题就会被随时发现。还有一种方案是有专门负责监督的成员在大家后面督促大家做性能分析的工作。


性能优化的优先级根据你正在开发的产品对性能的要求以及你当前的状态。作者的观点来自游戏开发中的渲染工程经验。在这个领域性能要求绝对严格。通常要保证每秒渲染成百上千的物件六十次，以及在毫秒级别渲染百万级别的像素。如果你自己开发的应用程序是在自己提供的硬件上运行，那增强硬件性能即可解决问题。但是游戏不吃这一套，其他大多说商业模式也不行。软件不是为我们自己而开发，并且我们也不能控制响应的硬件。我们内部都好说，用啥硬件都行，但是用户只会在他们自己的硬件上运行应用。更甚者，主机审核还有对游戏具体帧数的要求，不然就不得发布。

优化工作也不一定是必须的，其实也是经济账。比如你写个程序运行可能要花费半个小时，但你优化可能花费不止半个小时，那么如果只运行一次，那就没必要优化。但是如果你对优化工作非常喜爱，那另当别说。

当你正在工作的项目，某个系统有很多bug，那优先级最高的肯定是先解决这个系统模块的bug。但是如果你优化的模块没有bug，那就不耽误你优化这个模块的代码。

条目1,2,3,8是性能文化相关的主题。这是最重要的点。其他部分是具体优化工作的点。4,5没有多说。但是对于条目6，编译器确实在优化代码方面非常聪明。但是编译器的首要工作是保证正确性，并且编译器并不知道高效的算法。核心观点是明白你自己想如何做，最后通过汇编代码确保编译器是按照你的想法工作的。

[原文链接](http://www.humus.name/index.php?page=Comments&ID=383)